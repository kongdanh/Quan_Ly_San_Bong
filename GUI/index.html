<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sân Bóng - Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #34495e;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:hover {
            background-color: #34495e;
        }

        .menu-item.active {
            background-color: #3498db;
        }

        .menu-item a {
            color: inherit;
            text-decoration: none;
            display: block;
            width: 100%;
            height: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #3498db;
            color: white;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status-pending {
            background-color: #f1c40f;
            color: white;
        }

        .status-confirmed {
            background-color: #2ecc71;
            color: white;
        }

        .status-cancelled {
            background-color: #e74c3c;
            color: white;
        }

        .notification-card {
            background-color: #fff3cd;
            border-left: 5px solid #f1c40f;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-content label {
            font-weight: bold;
        }

        .modal-content input,
        .modal-content select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h2>QUẢN LÝ SÂN BÓNG</h2>
            </div>
            <div class="menu-item active"><a href="/index">Dashboard</a></div>
            <div class="menu-item"><a href="/san">Quản lý sân</a></div>
            <div class="menu-item"><a href="/khachhang">Quản lý Khách hàng</a></div>
            <div class="menu-item"><a href="/quanlitaichinh">Quản lý tài chính</a></div>
            <div class="menu-item"><a href="/nhanvien">Quản lý nhân viên</a></div>
            <div class="menu-item"><a href="/baocao">Báo cáo & Thống kê</a></div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Dashboard - {{ today_date }}</h1>
                <div>
                    <span>Xin chào, Quản trị viên</span>
                    <button class="btn btn-primary">
                        <a href="/login" style="color: white;">Đăng xuất</a>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div>Tổng phiếu ghi hôm nay</div>
                    <div class="stat-value">{{ total_bookings }}</div>
                </div>
                <div class="stat-card">
                    <div>Phiếu đã xác nhận</div>
                    <div class="stat-value">{{ confirmed_bookings }}</div>
                </div>
                <div class="stat-card">
                    <div>Doanh thu dự kiến</div>
                    <div class="stat-value">{{ "{:,.0f}đ".format(today_revenue) }}</div>
                </div>
            </div>

            <!-- Booking List -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Danh sách phiếu ghi hôm nay</h2>
                    <button class="btn btn-success" onclick="openModal()">Thêm phiếu ghi</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Người thuê</th>
                                <th>Sân</th>
                                <th>Khung giờ</th>
                                <th>Giá</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pg in pg %}
                            <tr>
                                <td>{{ pg.IdPhieuGhi | default(0) }}</td>
                                <td>{{ pg.HoTen | default('Không xác định') }}</td>
                                <td>Sân {{ pg.IdSan | default(0) }} ({{ pg.CoSan | default('Không xác định') }})</td>
                                <td>{{ pg.KhungGio | default('Chưa có') }}</td>
                                <td>{{ "{:,.0f}đ".format(pg.Gia | default(0)) }}</td>
                                <td>
                                    <span class="status 
                                        {% if pg.TrangThai == 'Chờ xác nhận' %}status-pending
                                        {% elif pg.TrangThai == 'Đã xác nhận' %}status-confirmed
                                        {% else %}status-cancelled{% endif %}">
                                        {{ pg.TrangThai | default('Chưa xác định') }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" style="text-align: center;">Không có phiếu ghi nào hôm nay</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notifications -->
            <div class="card notification-card">
                <h2>Thông báo: Phiếu ghi sắp đến giờ</h2>
                {% if upcoming_bookings %}
                <ul style="list-style: none; padding: 0;">
                    {% for pg in upcoming_bookings %}
                    <li style="padding: 10px 0; border-bottom: 1px solid #ddd;">
                        Phiếu <strong>#{{ pg.IdPhieuGhi }}</strong>:
                        <strong>{{ pg.HoTen or 'Không xác định' }}</strong> đặt
                        <strong>Sân {{ pg.IdSan }}</strong> khung
                        <strong>{{ pg.KhungGio }}</strong>
                        (Trạng thái: <span class="status 
                            {% if pg.TrangThai == 'Chờ xác nhận' %}status-pending
                            {% elif pg.TrangThai == 'Đã xác nhận' %}status-confirmed
                            {% else %}status-cancelled{% endif %}">
                            {{ pg.TrangThai }}</span>)
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Không có phiếu ghi nào sắp đến giờ trong 1 giờ tới.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for Adding New Booking -->
    <div id="addBookingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">×</span>
            <h2>Thêm phiếu ghi mới</h2>
            <form id="addBookingForm">
                <div class="form-group">
                    <label for="hoTen">Tên khách hàng:</label>
                    <input type="text" id="hoTen" name="hoTen" required>
                </div>
                <div class="form-group">
                    <label for="idSan">Chọn sân:</label>
                    <select id="idSan" name="idSan" required onchange="calculatePrice()">
                        <option value="" disabled selected>Chọn sân</option>
                        {% if danh_sach_san %}
                        {% for san in danh_sach_san %}
                        <option value="{{ san.IdSan }}" data-gia-san="{{ san.GiaSan | default(0) }}">{{ san.IdSan }} ({{
                            san.CoSan }}) - {{ san.DiaChi }}</option>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>Không có sân nào</option>
                        {% endif %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="khungGio">Khung giờ (VD: 14:00-15:00):</label>
                    <input type="text" id="khungGio" name="khungGio" placeholder="14:00-15:00" required
                        oninput="calculatePrice()">
                </div>
                <div class="form-group">
                    <label for="gia">Giá (VNĐ):</label>
                    <input type="number" id="gia" name="gia" readonly>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Hủy</button>
                    <button type="submit" class="btn-primary">Thêm</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Dữ liệu giá sân từ template
        const sanData = [
            {% if danh_sach_san %}
        {% for san in danh_sach_san %}
        { idSan: { { san.IdSan | default (0) } }, giaSan: { { san.GiaSan | default (0) } } },
        {% endfor %}
        {% endif %}].filter(san => san.idSan !== null && san.giaSan !== null && !isNaN(san.giaSan));
        console.log("sanData:", sanData);

        // Modal handling
        const modal = document.getElementById("addBookingModal");
        const addBookingForm = document.getElementById("addBookingForm");

        function openModal() {
            modal.style.display = "flex";
        }

        function closeModal() {
            modal.style.display = "none";
            addBookingForm.reset();
            document.getElementById("gia").value = "";
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // Tính giá tự động
        function calculatePrice() {
            const idSan = document.getElementById("idSan").value;
            const khungGio = document.getElementById("khungGio").value;
            const giaInput = document.getElementById("gia");

            if (!idSan || !khungGio) {
                giaInput.value = "";
                return;
            }

            // Lấy giá cơ bản từ sân
            const san = sanData.find(s => s.idSan == idSan);
            if (!san || san.giaSan === undefined || isNaN(san.giaSan)) {
                giaInput.value = "";
                console.error("Không tìm thấy giá sân hợp lệ cho IdSan:", idSan);
                return;
            }
            let gia = san.giaSan;

            // Xác định hệ số khung giờ
            let heSo = 1.0;
            try {
                const startTime = khungGio.split('-')[0]; // Lấy giờ bắt đầu, ví dụ: "14:00"
                const hour = parseInt(startTime.split(':')[0], 10); // Lấy giờ, ví dụ: 14

                if (hour >= 17 && hour < 22) {
                    heSo = 1.5; // Giờ cao điểm
                } else if (hour < 8 || hour >= 22) {
                    heSo = 0.8; // Giờ thấp điểm
                } else {
                    heSo = 1.0; // Giờ thường
                }
            } catch (e) {
                console.error("Lỗi khi phân tích khung giờ:", e);
                heSo = 1.0;
            }

            // Tính giá
            gia = gia * heSo;
            giaInput.value = Math.round(gia);
        }

        // Form submission
        addBookingForm.addEventListener("submit", function (event) {
            event.preventDefault();

            const khu = document.getElementById("khungGio").value;
            if (!isValidKhungGio(khu)) {
                alert("Khung giờ không hợp lệ! Vui lòng nhập theo định dạng 'HH:MM-HH:MM' (VD: 14:00-15:00) và đảm bảo thời gian hợp lý.");
                return;
            }

            const formData = {
                hoTen: document.getElementById("hoTen").value,
                idSan: document.getElementById("idSan").value,
                khungGio: document.getElementById("khungGio").value,
                gia: document.getElementById("gia").value,
                trangThai: "Chờ xác nhận"
            };

            fetch('/them-phieu-ghi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Thêm phiếu ghi thành công!');
                        window.location.reload();
                    } else {
                        alert('Lỗi: ' + (data.error || 'Không xác định'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi thêm phiếu ghi!');
                });
        });

        function isValidKhungGio(khungGio) {
            const regex = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])-([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
            if (!regex.test(khungGio)) {
                return false;
            }

            const [start, end] = khungGio.split('-');
            const [startHour, startMinute] = start.split(':').map(Number);
            const [endHour, endMinute] = end.split(':').map(Number);

            const startTime = startHour * 60 + startMinute;
            const endTime = endHour * 60 + endMinute;

            return startTime < endTime;
        }
    </script>
</body>

</html>